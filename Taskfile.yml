# ============================================================================
# GENERATED FILE - DO NOT EDIT MANUALLY
# ============================================================================
# Generated by: xplat manifest bootstrap
# Regenerate with: xplat manifest bootstrap --force
# Source: https://github.com/joeblew999/xplat
# ============================================================================
#
# plat-splat Taskfile - Run 'xplat task' to see available commands
#
# xplat file structure:
#   xplat.yaml              - Package manifest (defines binary, processes, env)
#   Taskfile.yml            - THIS FILE: all build/run/service tasks
#   taskfiles/Taskfile.service.yml - Generated reusable tasks for pkg consumers
#   process-compose.yaml    - Process orchestration (uses xplat task commands)
#
# xplat directory convention (external repo):
#   .src/   - cloned source repositories
#   .bin/   - built binaries
#   .data/  - runtime data

version: "3"

dotenv: ['.env']

vars:
  # xplat binary - all commands go through xplat for cross-platform support
  XPLAT: xplat

  # Binary configuration
  BINARY: polyform
  BINARY_FILE: 'polyform{{exeExt}}'
  VERSION: 'v0.35.0'
  UPSTREAM: 'https://github.com/EliCDavis/polyform.git'

  # xplat directory convention
  SRC_DIR: '{{.ROOT_DIR}}/.src/polyform'
  BIN_DIR: '{{.ROOT_DIR}}/.bin'
  BIN_PATH: '{{.BIN_DIR}}/{{.BINARY_FILE}}'
  DATA_DIR: '{{.ROOT_DIR}}/.data'

env:
  GOWORK: off

tasks:
  default:
    desc: Show available tasks
    cmds:
      - '{{.XPLAT}} task --list'

  # ===========================================================================
  # Setup - First time initialization
  # ===========================================================================

  setup:
    desc: First time setup - clone and build polyform
    cmds:
      - task: src:clone
      - task: bin:build

  # ===========================================================================
  # Source Management - Clone/update upstream repository
  # ===========================================================================

  src:clone:
    desc: Clone polyform repository at pinned version
    vars:
      CLONE_CMD: git clone --depth 1 --branch {{.VERSION}} {{.UPSTREAM}} {{.SRC_DIR}}
    cmds:
      - '{{.XPLAT}} os mkdir -p {{.ROOT_DIR}}/.src'
      - '{{if eq OS "windows"}}if (!(Test-Path "{{.SRC_DIR}}/.git")) { {{.CLONE_CMD}} }{{else}}[ -d "{{.SRC_DIR}}/.git" ] || {{.CLONE_CMD}}{{end}}'

  src:update:
    desc: Fetch and checkout pinned version
    deps: [src:clone]
    dir: '{{.SRC_DIR}}'
    cmds:
      - git fetch --tags
      - git checkout {{.VERSION}}

  # ===========================================================================
  # Binary Build - Compile from source
  # ===========================================================================

  bin:build:
    desc: Build polyform binary from source
    deps: [src:clone]
    dir: '{{.SRC_DIR}}'
    cmds:
      - '{{.XPLAT}} os mkdir -p {{.BIN_DIR}}'
      - go build -o {{.BIN_PATH}} ./cmd/polyform
      - |
        # Create version file for tracking
        VERSION=$(git describe --tags --always 2>/dev/null || echo "{{.VERSION}}")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        cat > {{.BIN_DIR}}/.version << EOF
        version: $VERSION
        commit: $COMMIT
        built: $(date -u +%Y-%m-%dT%H:%M:%SZ)
        EOF
    status:
      - '{{if eq OS "windows"}}Test-Path "{{.BIN_PATH}}"{{else}}test -f "{{.BIN_PATH}}"{{end}}'

  ensure:
    desc: Ensure polyform binary exists (build if needed)
    status:
      - '{{if eq OS "windows"}}Test-Path "{{.BIN_PATH}}"{{else}}test -f "{{.BIN_PATH}}"{{end}}'
    cmds:
      - task: bin:build

  # ===========================================================================
  # Run - Execute the binary
  # ===========================================================================

  run:
    desc: Run polyform
    deps: [ensure]
    cmds:
      - '{{.BIN_PATH}} edit'

  # ===========================================================================
  # Process Compose Integration
  # These use the <binary>:run and <binary>:health naming convention
  # ===========================================================================

  polyform:run:
    desc: Run polyform (called by process-compose)
    deps: [ensure]
    cmds:
      - '{{.BIN_PATH}} edit -launch-browser=false'

  polyform:health:
    desc: Health check for polyform (called by process-compose readiness probe)
    cmds:
      - curl -sf http://localhost:8080/ > /dev/null || exit 1

  # ===========================================================================
  # Process Compose - Orchestration commands
  # ===========================================================================

  up:
    desc: Start polyform with process-compose TUI
    deps: [ensure]
    cmds:
      - '{{.XPLAT}} process up'

  up:detached:
    desc: Start polyform in background
    deps: [ensure]
    cmds:
      - '{{.XPLAT}} process up -t=false -d'

  down:
    desc: Stop polyform
    cmds:
      - '{{.XPLAT}} process down'

  # ===========================================================================
  # Development - Testing and dependencies
  # ===========================================================================

  test:
    desc: Run polyform tests
    deps: [src:clone]
    dir: '{{.SRC_DIR}}'
    cmds:
      - go test -v ./...

  deps:
    desc: Download polyform dependencies
    deps: [src:clone]
    dir: '{{.SRC_DIR}}'
    cmds:
      - go mod download

  # ===========================================================================
  # Clean - Remove generated artifacts
  # ===========================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - '{{.XPLAT}} os rm -rf {{.BIN_DIR}}'

  clean:src:
    desc: Clean source directory
    cmds:
      - '{{.XPLAT}} os rm -rf {{.SRC_DIR}}'

  clean:data:
    desc: Clean data directory
    cmds:
      - '{{.XPLAT}} os rm -rf {{.DATA_DIR}}'

  clean:all:
    desc: Clean everything (.src, .bin, .data)
    cmds:
      - '{{.XPLAT}} os rm -rf {{.ROOT_DIR}}/.src {{.ROOT_DIR}}/.bin {{.ROOT_DIR}}/.data'

  # ===========================================================================
  # Info - Version and manifest information
  # ===========================================================================

  version:
    desc: Show polyform version
    deps: [ensure]
    cmds:
      - '{{.BIN_PATH}} --version || echo "{{.VERSION}}"'

  manifest:
    desc: Show pinned vs installed versions
    cmds:
      - |
        echo "=== polyform Version ==="
        echo ""
        echo "Pinned:  {{.VERSION}}"
        if [ -f "{{.BIN_DIR}}/.version" ]; then
          echo "Installed:"
          cat "{{.BIN_DIR}}/.version"
        else
          echo "Installed: (not built)"
        fi

  # ===========================================================================
  # Release Commands (called by CI on tags)
  # ===========================================================================

  release:build:
    desc: Build release binary for current platform
    deps: [ensure]
    cmds:
      - '{{.XPLAT}} os mkdir -p {{.ROOT_DIR}}/.releases'
      - '{{.XPLAT}} os cp {{.BIN_PATH}} {{.ROOT_DIR}}/.releases/{{.BINARY}}-{{OS}}-{{ARCH}}{{exeExt}}'

  release:list:
    desc: List built release binaries
    cmds:
      - ls -la .releases/ 2>/dev/null || echo "No releases built yet"

